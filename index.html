<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Monitoring App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Dark Theme CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- vis.js CSS -->
    <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.0/dist/vis-network.min.css" rel="stylesheet">
    <style>
        .status-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-circle.grey {
            background-color: grey;
        }
        .status-circle.green {
            background-color: #28a745; /* Bootstrap success green */
        }
        .status-circle.red {
            background-color: #dc3545; /* Bootstrap danger red */
        }
        .card {
            height: 100%; /* Ensures box height matches content */
        }
        .card-body {
            padding: 10px; /* Reduced padding for compact boxes */
        }
        .icon-link {
            color: inherit;
            text-decoration: none;
        }
        .icon-link:hover {
            color: #0d6efd; /* Bootstrap primary blue */
        }
        #network-graph {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body class="bg-dark">
    <div id="app" class="container mt-5">
        <h1 class="text-center mb-4 text-white">WordPress Monitoring Dashboard</h1>
        <div class="alert alert-success text-dark" role="alert">
            <strong>Total Apps:</strong> {{ totalApps }} |
            <strong>OK Apps:</strong> {{ okApps }} |
            <strong>Down Apps:</strong> {{ downApps }}
        </div>
        <div class="row" id="app-list">
            <div v-for="app in apps" :key="app.name" class="col-12 col-md-4 mb-3">
                <div class="card text-white bg-secondary">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div :class="['status-circle', app.status]"></div>
                            <span class="ms-3">{{ app.name }}</span>
                        </div>
                        <div>
                            <a :href="app.url" target="_blank" class="icon-link me-2">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            <a href="#" @click.prevent="inspectApp(app)" class="icon-link">
                                <i class="bi bi-search"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inspect Modal -->
        <div class="modal fade" id="inspectModal" tabindex="-1" aria-labelledby="inspectModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title" id="inspectModalLabel">Inspecting {{ currentApp?.name }}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="loading" class="text-center">
                            <div class="spinner-border text-light" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div v-else>
                            <div id="network-graph"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
    <!-- vis.js for graph visualization -->
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.0/dist/vis-network.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                apps: [],
                currentApp: null,
                loading: false,
                intervalId: null
            },
            computed: {
                totalApps() {
                    return this.apps.length;
                },
                okApps() {
                    return this.apps.filter(app => app.status === 'green').length;
                },
                downApps() {
                    return this.apps.filter(app => app.status === 'red').length;
                }
            },
            methods: {
                fetchApps() {
                    axios.get('https://api.runonflux.io/apps/globalappsspecifications/')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.apps = response.data.data
                                    .filter(app => app.name.startsWith('wordpress'))
                                    .map(app => {
                                        const operator = app.compose.find(c => c.name === 'operator');
                                        const OpPort = operator?.ports[operator.ports.length - 1] || null;
                                        return {
                                            ...app,
                                            status: 'grey',
                                            OpPort,
                                            url: `https://${app.name}.app.runonflux.io`
                                        };
                                    });
                                this.checkAppStatuses();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching apps:', error);
                        });
                },
                checkAppStatuses() {
                    this.apps.forEach(app => {
                        axios.head(app.url, { timeout: 10000 })
                            .then(response => {
                                app.status = response.status === 200 ? 'green' : 'red';
                            })
                            .catch(() => {
                                app.status = 'red';
                            });
                    });
                },
                inspectApp(app) {
                    this.currentApp = app;
                    this.loading = true;
                    const modal = new bootstrap.Modal(document.getElementById('inspectModal'));
                    modal.show();
                    this.fetchAppLocations(app);
                },
                fetchAppLocations(app) {
                    axios.get(`https://api.runonflux.io/apps/location/${app.name}`)
                        .then(response => {
                            if (response.data.status === 'success') {
                                const ips = response.data.data.map(item => {
                                    const ipPort = item.ip.split(':');
                                    return ipPort[0]; // Remove port if present
                                });
                                this.fetchStatusForIPs(ips, app.OpPort);
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching app locations:', error);
                            this.loading = false;
                        });
                },
                fetchStatusForIPs(ips, OpPort) {
                    const promises = ips.map(ip => {
                        const url = `http://${ip}:${OpPort}/status`;
                        return axios.get(url)
                            .then(response => ({ ip, data: response.data }))
                            .catch(() => ({ ip, data: null }));
                    });
                    Promise.all(promises)
                        .then(results => {
                            this.createGraph(results);
                        })
                        .catch(error => {
                            console.error('Error fetching status for IPs:', error);
                            this.loading = false;
                        });
                },
                createGraph(statusResults) {
                    const nodes = [];
                    const edges = [];
                    const ipToId = {};

                    // Create nodes
                    statusResults.forEach((result, index) => {
                        const id = index + 1;
                        ipToId[result.ip] = id;
                        const label = `${result.ip}\n${result.data ? result.data.status : 'Error'}`;
                        nodes.push({ id, label, color: result.data ? '#28a745' : '#dc3545' });
                    });

                    // Create edges
                    statusResults.forEach(result => {
                        if (result.data) {
                            const fromId = ipToId[result.ip];
                            // Master link
                            if (result.data.masterIP && ipToId[result.data.masterIP]) {
                                edges.push({
                                    from: fromId,
                                    to: ipToId[result.data.masterIP],
                                    color: { color: '#28a745' },
                                    dashes: false
                                });
                            }
                            // Cluster status links
                            result.data.clusterStatus.forEach(cluster => {
                                if (ipToId[cluster.ip.split(':')[0]]) {
                                    edges.push({
                                        from: fromId,
                                        to: ipToId[cluster.ip.split(':')[0]],
                                        color: { color: cluster.active ? '#28a745' : '#dc3545' },
                                        dashes: true
                                    });
                                }
                            });
                        }
                    });

                    // Create graph
                    const container = document.getElementById('network-graph');
                    const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
                    const options = {
                        nodes: {
                            shape: 'box',
                            font: { color: '#ffffff' }
                        },
                        edges: {
                            arrows: 'to'
                        }
                    };
                    new vis.Network(container, data, options);
                    this.loading = false;
                }
            },
            mounted() {
                this.fetchApps();
                this.intervalId = setInterval(this.fetchApps, 5 * 60 * 1000); // Update every 5 minutes
            },
            beforeDestroy() {
                clearInterval(this.intervalId);
            }
        });
    </script>
</body>
</html>
